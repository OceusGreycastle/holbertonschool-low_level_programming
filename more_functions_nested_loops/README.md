More functions and nested loops. oh boy.
